<script>
const YOUTUBE_API_KEY = "MASUKKAN_API_KEY_ANDA_DI_SINI";

let players = [];
let urls = [];
let videoDurations = [];
let currentIndex = 0;
let activeIndexes = [];
let timerNext = null;
let batchNumber = 0;
let readyCount = 0;
let batchSize = 0;

function onYouTubeIframeAPIReady() {
  console.log("YouTube IFrame API Ready");
}

function extractVideoId(url) {
  let match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})(?:[?&]|$)/);
  return match ? match[1] : null;
}

async function fetchDurations(videoIds) {
  const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoIds.join(",")}&key=${YOUTUBE_API_KEY}`;
  const res = await fetch(apiUrl);
  const data = await res.json();
  let durations = {};
  data.items.forEach(item => {
    durations[item.id] = isoDurationToSeconds(item.contentDetails.duration);
  });
  return durations;
}

function isoDurationToSeconds(iso) {
  const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  const hours = parseInt(match[1] || 0);
  const minutes = parseInt(match[2] || 0);
  const seconds = parseInt(match[3] || 0);
  return hours * 3600 + minutes * 60 + seconds;
}

async function startPlayers() {
  urls = document.getElementById("urls").value
    .split("\n")
    .map(u => u.trim())
    .filter(u => u.length > 0)
    .slice(0, 10);

  if (urls.length === 0) {
    alert("Masukkan minimal 1 URL YouTube.");
    return;
  }

  // Ambil semua videoId
  let videoIds = urls.map(extractVideoId).filter(Boolean);

  // Ambil durasi dari API
  try {
    let durationMap = await fetchDurations(videoIds);
    videoDurations = videoIds.map(id => durationMap[id] || 0);
  } catch (err) {
    alert("Gagal mengambil durasi video. Periksa API Key atau koneksi internet.");
    return;
  }

  currentIndex = 0;
  batchNumber = 0;
  nextBatch(); // mulai batch pertama
}

function nextBatch() {
  if (timerNext) {
    clearTimeout(timerNext);
    timerNext = null;
  }

  if (currentIndex >= urls.length) {
    document.getElementById("status").innerText = "Status: Semua video sudah diputar.";
    document.getElementById("playerGrid").innerHTML = "";
    return;
  }

  // Hapus semua frame lama
  document.getElementById("playerGrid").innerHTML = "";
  players = [];
  activeIndexes = [];
  readyCount = 0;
  batchNumber++;

  batchSize = Math.floor(Math.random() * 2) + 2; // 2-3 video
  let maxDuration = 0;

  for (let i = 0; i < batchSize && currentIndex < urls.length; i++) {
    let idx = currentIndex++;
    activeIndexes.push(idx);

    let div = document.createElement("div");
    div.id = "player" + idx;
    document.getElementById("playerGrid").appendChild(div);

    let videoId = extractVideoId(urls[idx]);
    if (videoId) {
      players[idx] = new YT.Player(div.id, {
        videoId: videoId,
        playerVars: { modestbranding: 1, rel: 0, playsinline: 1 },
        events: { onReady: onPlayerReady }
      });

      if (videoDurations[idx] > maxDuration) {
        maxDuration = videoDurations[idx];
      }
    }
  }

  // Update status batch
  document.getElementById("status").innerText =
    `Status: Memutar Batch ${batchNumber} (${batchSize} video), durasi terlama ${maxDuration} detik.`;

  // Jadwalkan batch berikutnya otomatis
  if (maxDuration > 0) {
    timerNext = setTimeout(() => {
      if (currentIndex < urls.length) nextBatch();
    }, maxDuration * 1000);
  }
}

function onPlayerReady(event) {
  readyCount++;
  if (readyCount === batchSize) {
    // Semua player batch siap â†’ autoplay semuanya
    setTimeout(() => {
      activeIndexes.forEach(idx => {
        if (players[idx]) {
          players[idx].playVideo();
        }
      });
    }, 500); // delay 0.5 detik biar iframe siap play
  }
}
</script>
