<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Multi-Frame Player with API Duration</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 0; text-align: center; }
  #inputArea { max-width: 600px; margin: 15px auto; display: flex; flex-direction: column; gap: 8px; }
  textarea { width: 100%; min-height: 100px; padding: 8px; }
  button { padding: 10px; font-size: 14px; border: none; background: #cc0000; color: white; cursor: pointer; border-radius: 5px; }
  button:hover { background: #e60000; }
  #playerGrid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); padding: 10px; max-width: 1000px; margin: auto; }
  iframe { width: 100%; aspect-ratio: 16/9; background: black; }
</style>
</head>
<body>

<h1>Multi-Frame YouTube Player</h1>

<div id="inputArea">
  <textarea id="urls" placeholder="Masukkan maksimal 10 URL YouTube, satu per baris"></textarea>
  <div>
    <button onclick="startPlayers()">Play All</button>
    <button onclick="nextBatch()">Next</button>
  </div>
</div>

<div id="playerGrid"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const YOUTUBE_API_KEY = "AIzaSyB3qnP-jtxCmwNHtB4NzmryIlHO_XySKns";

let players = [];
let urls = [];
let videoDurations = [];
let currentIndex = 0;
let batchPlaying = [];
let timerNext = null;

function onYouTubeIframeAPIReady() {
  console.log("YouTube IFrame API Ready");
}

function extractVideoId(url) {
  let match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})(?:[?&]|$)/);
  return match ? match[1] : null;
}

async function fetchDurations(videoIds) {
  const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoIds.join(",")}&key=${YOUTUBE_API_KEY}`;
  const res = await fetch(apiUrl);
  const data = await res.json();
  let durations = {};
  data.items.forEach(item => {
    durations[item.id] = isoDurationToSeconds(item.contentDetails.duration);
  });
  return durations;
}

function isoDurationToSeconds(iso) {
  const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  const hours = parseInt(match[1] || 0);
  const minutes = parseInt(match[2] || 0);
  const seconds = parseInt(match[3] || 0);
  return hours * 3600 + minutes * 60 + seconds;
}

async function startPlayers() {
  urls = document.getElementById("urls").value
    .split("\n")
    .map(u => u.trim())
    .filter(u => u.length > 0)
    .slice(0, 10);

  if (urls.length === 0) {
    alert("Masukkan minimal 1 URL YouTube.");
    return;
  }

  // Ambil semua videoId
  let videoIds = urls.map(extractVideoId).filter(Boolean);

  // Ambil durasi dari API
  let durationMap = await fetchDurations(videoIds);
  videoDurations = videoIds.map(id => durationMap[id] || 0);

  // Reset player grid
  document.getElementById("playerGrid").innerHTML = "";
  players = [];
  currentIndex = 0;

  urls.forEach((url, i) => {
    let div = document.createElement("div");
    div.id = "player" + i;
    document.getElementById("playerGrid").appendChild(div);

    let videoId = extractVideoId(url);
    if (videoId) {
      players[i] = new YT.Player(div.id, {
        videoId: videoId,
        playerVars: { modestbranding: 1, rel: 0, playsinline: 1 }
      });
    }
  });

  setTimeout(nextBatch, 1000);
}

function nextBatch() {
  if (timerNext) {
    clearTimeout(timerNext);
    timerNext = null;
  }

  // Pause semua
  players.forEach(p => { if (p && p.pauseVideo) p.pauseVideo(); });

  // Pilih batch baru 2 atau 3 video
  batchPlaying = [];
  let batchSize = Math.floor(Math.random() * 2) + 2;

  let maxDuration = 0;
  for (let i = 0; i < batchSize && currentIndex < urls.length; i++) {
    let idx = currentIndex++;
    if (players[idx]) {
      players[idx].playVideo();
      batchPlaying.push(idx);

      if (videoDurations[idx] > maxDuration) {
        maxDuration = videoDurations[idx];
      }
    }
  }

  // Jadwalkan batch berikutnya otomatis
  if (maxDuration > 0) {
    timerNext = setTimeout(() => {
      if (currentIndex < urls.length) nextBatch();
    }, maxDuration * 1000);
  }
}
</script>

</body>
</html>
